!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).BpmnJSBpmnlint=e()}(this,(function(){"use strict";function t(t,e){var n=t.get("editorActions",!1);n&&n.register({toggleLinting:function(){e.toggle()}})}t.$inject=["injector","linting"];class e{constructor({moddleRoot:t,rule:e}){this.rule=e,this.moddleRoot=t,this.messages=[],this.report=this.report.bind(this)}report(t,e){this.messages.push({id:t,message:e})}}const n={0:"off",1:"warn",2:"error"};function r(t={}){const{config:e,resolver:n}=t;if(void 0===n)throw new Error("must provide <options.resolver>");this.config=e,this.resolver=n,this.cachedRules={},this.cachedConfigs={}}var i=r;function o(t,e){const n=t.rules||{},r=e.startsWith("bpmnlint-plugin-")&&e.replace("bpmnlint-plugin-",""),i=Object.keys(n).reduce((t,e)=>{const i=n[e];return e.startsWith("bpmnlint/")?e=e.replace("bpmnlint/",""):r&&(e.startsWith(r)||(e=`${r}/${e}`)),t[e]=i,t},{});return{...t,rules:i}}r.prototype.applyRule=function(t,n){const{config:r,rule:i,category:o,name:s}=n;try{return function({moddleRoot:t,rule:n}){const r=new e({rule:n,moddleRoot:t});return function t(e,n){n(e);var r=e.$descriptor;r.isGeneric||r.properties.filter(t=>!t.isAttr&&!t.isReference&&"String"!==t.type).forEach(r=>{if(r.name in e){const i=e[r.name];r.isMany?i.forEach(e=>{t(e,n)}):t(i,n)}})}(t,t=>n.check(t,r)),r.messages}({moddleRoot:t,rule:i,config:r}).map((function(t){return{...t,category:o}}))}catch(t){return console.error("rule <"+s+"> failed with error: ",t),[{message:"Rule error: "+t.message,category:"error"}]}},r.prototype.resolveRule=function(t){const{pkg:e,ruleName:n}=this.parseRuleName(t),r=`${e}-${n}`,i=this.cachedRules[r];return i?Promise.resolve(i):Promise.resolve(this.resolver.resolveRule(e,n)).then(e=>{if(!e)throw new Error(`unknown rule <${t}>`);return this.cachedRules[r]=e()})},r.prototype.resolveConfig=function(t){const{pkg:e,configName:n}=this.parseConfigName(t),r=`${e}-${n}`,i=this.cachedConfigs[r];return i?Promise.resolve(i):Promise.resolve(this.resolver.resolveConfig(e,n)).then(n=>{if(!n)throw new Error(`unknown config <${t}>`);return this.cachedConfigs[r]=o(n,e)})},r.prototype.resolveRules=function(t){return this.resolveConfiguredRules(t).then(t=>{const e=Object.entries(t).map(([t,e])=>{const{category:n,config:r}=this.parseRuleValue(e);return{name:t,category:n,config:r}}).filter(t=>"off"!==t.category).map(t=>{const{name:e}=t;return this.resolveRule(e).then((function(e){return{...t,rule:e}}))});return Promise.all(e)})},r.prototype.resolveConfiguredRules=function(t){let e=t.extends;return"string"==typeof e&&(e=[e]),void 0===e&&(e=[]),Promise.all(e.map(t=>this.resolveConfig(t).then(t=>this.resolveConfiguredRules(t)))).then(e=>[...e,o(t,"bpmnlint").rules].reduce((t,e)=>({...t,...e}),{}))},r.prototype.lint=function(t,e){return e=e||this.config,this.resolveRules(e).then(e=>{const n={};return e.forEach(e=>{const{name:r}=e,i=this.applyRule(t,e);i.length&&(n[r]=i)}),n})},r.prototype.parseRuleValue=function(t){let e,r;return Array.isArray(t)?(e=t[0],r=t[1]):(e=t,r={}),"string"==typeof e&&(e=e.toLowerCase()),e=n[e]||e,{config:r,category:e}},r.prototype.parseRuleName=function(t){const e=t.indexOf("/");if(-1===e)return{pkg:"bpmnlint",ruleName:t};const n=t.substring(0,e),r=t.substring(e+1);return"bpmnlint"===n?{pkg:"bpmnlint",ruleName:r}:{pkg:"bpmnlint-plugin-"+n,ruleName:r}},r.prototype.parseConfigName=function(t){const e=/^bpmnlint:(.*)$/.exec(t);if(e)return{pkg:"bpmnlint",configName:e[1]};const n=/^plugin:([^/]+)\/(.+)$/.exec(t);if(!n)throw new Error(`invalid config name <${t}>`);return{pkg:"bpmnlint-plugin-"+n[1],configName:n[2]}};var s={Linter:i}.Linter,l=Object.prototype.toString,c=Object.prototype.hasOwnProperty;function a(t,e){return c.call(t,e)}function u(t,e){var n;if(void 0!==t){var r=function(t){return"[object Array]"===l.call(t)}(t)?g:h;for(var i in t)if(a(t,i)&&!1===e(n=t[i],r(i)))return n}}function p(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e=f(e),u(t,(function(t){var r=e(t)||"_",i=n[r];i||(i=n[r]=[]),i.push(t)})),n}function f(t){return e=t,"[object Function]"===(n=l.call(e))||"[object AsyncFunction]"===n||"[object GeneratorFunction]"===n||"[object AsyncGeneratorFunction]"===n||"[object Proxy]"===n?t:function(e){return e[t]};var e,n}function h(t){return t}function g(t){return Number(t)}function d(){return(d=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function v(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return d.apply(void 0,[t].concat(n))}var m,y=Element.prototype,b=(y.matchesSelector||y.webkitMatchesSelector||y.mozMatchesSelector||y.msMatchesSelector||y.oMatchesSelector,window.addEventListener,window.removeEventListener,function(t,e){if("string"!=typeof t)throw new TypeError("String expected");e||(e=document);var n=/<([\w:]+)/.exec(t);if(!n)return e.createTextNode(t);t=t.replace(/^\s+|\s+$/g,"");var r=n[1];if("body"==r){return(i=e.createElement("html")).innerHTML=t,i.removeChild(i.lastChild)}var i,o=w[r]||w._default,s=o[0],l=o[1],c=o[2];(i=e.createElement("div")).innerHTML=l+t+c;for(;s--;)i=i.lastChild;if(i.firstChild==i.lastChild)return i.removeChild(i.firstChild);var a=e.createDocumentFragment();for(;i.firstChild;)a.appendChild(i.removeChild(i.firstChild));return a}),_=!1;"undefined"!=typeof document&&((m=document.createElement("div")).innerHTML='  <link/><table></table><a href="/a">a</a><input type="checkbox"/>',_=!m.getElementsByTagName("link").length,m=void 0);var w={legend:[1,"<fieldset>","</fieldset>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],_default:_?[1,"X<div>","</div>"]:[0,"",""]};w.td=w.th=[3,"<table><tbody><tr>","</tr></tbody></table>"],w.option=w.optgroup=[1,'<select multiple="multiple">',"</select>"],w.thead=w.tbody=w.colgroup=w.caption=w.tfoot=[1,"<table>","</table>"],w.polyline=w.ellipse=w.polygon=w.circle=w.text=w.line=w.path=w.rect=w.g=[1,'<svg xmlns="http://www.w3.org/2000/svg" version="1.1">',"</svg>"];var C="undefined"!=typeof Element?Element.prototype:{},S=(C.matches||C.matchesSelector||C.webkitMatchesSelector||C.mozMatchesSelector||C.msMatchesSelector||C.oMatchesSelector,"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{});!function(t,e){t(e={exports:{}},e.exports)}((function(t,e){var n;n=S,t.exports=function(t){if(t.CSS&&t.CSS.escape)return t.CSS.escape;var e=function(t){if(0==arguments.length)throw new TypeError("`CSS.escape` requires an argument.");for(var e,n=String(t),r=n.length,i=-1,o="",s=n.charCodeAt(0);++i<r;)0!=(e=n.charCodeAt(i))?o+=e>=1&&e<=31||127==e||0==i&&e>=48&&e<=57||1==i&&e>=48&&e<=57&&45==s?"\\"+e.toString(16)+" ":0==i&&1==r&&45==e||!(e>=128||45==e||95==e||e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122)?"\\"+n.charAt(i):n.charAt(i):o+="ï¿½";return o};return t.CSS||(t.CSS={}),t.CSS.escape=e,e}(n)}));var E={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function j(t){return(t=""+t)&&t.replace(/[&<>"']/g,(function(t){return E[t]}))}var R='<svg width="12" height="12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path fill="currentColor" d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"></path></svg>',x='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 512 512"><path fill="currentColor" d="M288 328.83c-45.518 0-82.419 34.576-82.419 77.229 0 42.652 36.9 77.229 82.419 77.229 45.518 0 82.419-34.577 82.419-77.23 0-42.652-36.9-77.229-82.419-77.229zM207.439 57.034l11.61 204.348c.544 9.334 8.78 16.64 18.755 16.64h100.392c9.975 0 18.211-7.306 18.754-16.64l11.611-204.348c.587-10.082-7.98-18.56-18.754-18.56H226.192c-10.775 0-19.34 8.478-18.753 18.56z"/></svg>',L='<svg width="12" height="12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"></path></svg>',A={resolver:{resolveRule:function(){return null}},config:{}},B={error:R,warning:x,success:L,inactive:L};function k(t,e,n,r,i,o,s){this._bpmnjs=t,this._canvas=e,this._elementRegistry=r,this._eventBus=i,this._overlays=o,this._translate=s,this._issues={},this._active=n&&n.active||!1,this._linterConfig=A,this._overlayIds={};var l=this;i.on(["import.done","elements.changed","linting.configChanged","linting.toggle"],500,(function(t){l.isActive()&&l.update()})),i.on("linting.toggle",(function(t){t.active||(l._clearIssues(),l._updateButton())})),i.on("diagram.clear",(function(){l._clearIssues()}));var c=n&&n.bpmnlint;c&&i.once("diagram.init",(function(){if(l.getLinterConfig()===A)try{l.setLinterConfig(c)}catch(t){console.error("[bpmn-js-bpmnlint] Invalid lint rules configured. Please doublecheck your linting.bpmnlint configuration, cf. https://github.com/bpmn-io/bpmn-js-bpmnlint#configure-lint-rules")}})),this._init()}return k.prototype.setLinterConfig=function(t){if(!t.config||!t.resolver)throw new Error("Expected linterConfig = { config, resolver }");this._linterConfig=t,this._eventBus.fire("linting.configChanged")},k.prototype.getLinterConfig=function(){return this._linterConfig},k.prototype._init=function(){this._createButton(),this._updateButton()},k.prototype.isActive=function(){return this._active},k.prototype._formatIssues=function(t){var e,n;return p((e=function(t,e,n){return t.concat(e.map((function(t){return t.rule=n,t})))},n=[],u(t,(function(t,r){n=e(n,t,r)})),n),(function(t){return t.id}))},k.prototype.toggle=function(t){return t=void 0===t?!this.isActive():t,this._setActive(t),t},k.prototype._setActive=function(t){this._active!==t&&(this._active=t,this._eventBus.fire("linting.toggle",{active:t}))},k.prototype.update=function(){var t=this;if(this._bpmnjs.getDefinitions()){var e=this._lintStart=Math.random();this.lint().then((function(n){if(t._lintStart===e){n=t._formatIssues(n);var r={},i={},o={};for(var s in t._issues)n[s]||(r[s]=t._issues[s]);for(var l in n)t._issues[l]?n[l]!==t._issues[l]&&(i[l]=n[l]):o[l]=n[l];r=v(r,i),o=v(o,i),t._clearOverlays(),t._createIssues(o),t._issues=n,t._updateButton(),t._fireComplete(n)}}))}},k.prototype._fireComplete=function(t){this._eventBus.fire("linting.completed",{issues:t})},k.prototype._createIssues=function(t){for(var e in t)this._createElementIssues(e,t[e])},k.prototype._createElementIssues=function(t,e){var n=this._elementRegistry.get(t);if(n){var r,i;n===this._canvas.getRootElement()?(r="bottom-right",i={top:20,left:150}):(r="top-right",i={top:-7,left:-7});var o=p(e,(function(t){return t.category})),s=o.error,l=o.warn;if(s||l){var c=b('<div class="bjsl-overlay bjsl-issues-'+r+'"></div>'),a=b(s?'<div class="bjsl-icon bjsl-icon-error">'+R+"</div>":'<div class="bjsl-icon bjsl-icon-warning">'+x+"</div>"),u=b('<div class="bjsl-dropdown"></div>'),f=b('<div class="bjsl-dropdown-content"></div>'),h=b('<div class="bjsl-issues"></div>'),g=b("<ul></ul>");c.appendChild(a),c.appendChild(u),u.appendChild(f),f.appendChild(h),h.appendChild(g),s&&this._addErrors(g,s),l&&this._addWarnings(g,l),this._overlayIds[t]=this._overlays.add(n,"linting",{position:i,html:c,scale:{min:.9}})}}},k.prototype._addErrors=function(t,e){var n=this;e.forEach((function(e){n._addEntry(t,"error",e)}))},k.prototype._addWarnings=function(t,e){var n=this;e.forEach((function(e){n._addEntry(t,"warning",e)}))},k.prototype._addEntry=function(t,e,n){var r=n.rule,i=this._translate(n.message),o=b('<li class="'+e+'">'+B[e]+'<a title="'+j(r)+": "+j(i)+'" data-rule="'+j(r)+'" data-message="'+j(i)+'">'+j(i)+"</a></li>");t.appendChild(o)},k.prototype._clearOverlays=function(){this._overlays.remove({type:"linting"}),this._overlayIds={}},k.prototype._clearIssues=function(){this._issues={},this._clearOverlays()},k.prototype._setButtonState=function(t,e,n){var r=this._button,i=B[t]+"<span>"+this._translate("{errors} Errors, {warnings} Warnings",{errors:e.toString(),warnings:n.toString()})+"</span>";["error","inactive","success","warning"].forEach((function(e){t===e?r.classList.add("bjsl-button-"+e):r.classList.remove("bjsl-button-"+e)})),r.innerHTML=i},k.prototype._updateButton=function(){if(this.isActive()){var t=0,e=0;for(var n in this._issues)this._issues[n].forEach((function(n){"error"===n.category?t++:"warn"===n.category&&e++}));var r=(t?"error":e&&"warning")||"success";this._setButtonState(r,t,e)}else this._setButtonState("inactive",0,0)},k.prototype._createButton=function(){var t=this;this._button=b('<button class="bjsl-button bjsl-button-inactive" title="'+this._translate("Toggle linting")+'"></button>'),this._button.addEventListener("click",(function(){t.toggle()})),this._canvas.getContainer().appendChild(this._button)},k.prototype.lint=function(){var t=this._bpmnjs.getDefinitions();return new s(this._linterConfig).lint(t)},k.$inject=["bpmnjs","canvas","config.linting","elementRegistry","eventBus","overlays","translate"],{__init__:["linting","lintingEditorActions"],linting:["type",k],lintingEditorActions:["type",t]}}));
